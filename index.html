<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบจัดการสต๊อกวัสดุ Test Kit - กลุ่มวิจัยเคมีดิน</title>
  
  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- jsPDF & AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* Facebook-inspired Theme */
    :root {
      --fb-bg: #f0f2f5;
      --fb-header: #ffffff;
      --fb-primary: #0866ff;
      --fb-primary-hover: #075ce5;
      --fb-text: #050505;
      --fb-secondary-text: #65676b;
      --fb-card-bg: #ffffff;
      --fb-divider: #ced0d4;
      --fb-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    body { font-family: 'Kanit', sans-serif; background-color: var(--fb-bg); color: var(--fb-text); }
    .hidden { display: none !important; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #bcc0c4; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

    /* Animations */
    .fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Components */
    .fb-card { background: var(--fb-card-bg); border-radius: 8px; box-shadow: var(--fb-shadow); }
    .fb-btn { background-color: var(--fb-primary); color: white; font-weight: 600; border-radius: 6px; transition: background 0.2s; }
    .fb-btn:hover { background-color: var(--fb-primary-hover); }
    .fb-input { background-color: #f0f2f5; border: 1px solid transparent; border-radius: 20px; padding: 8px 16px; transition: 0.2s; }
    .fb-input:focus { border-color: var(--fb-primary); background: #fff; outline: none; box-shadow: 0 0 0 2px rgba(8, 102, 255, 0.2); }
    
    /* Sidebar Navigation Item */
    .nav-item { 
      display: flex; 
      align-items: center; 
      padding: 10px 12px; 
      border-radius: 8px; 
      font-weight: 500; 
      color: var(--fb-text); 
      transition: background 0.2s;
      margin-bottom: 4px;
    }
    .nav-item:hover { background-color: #e4e6eb; }
    .nav-item.active-nav { background-color: #e7f3ff; color: var(--fb-primary); }
    .nav-item i { width: 32px; text-align: center; font-size: 1.25rem; margin-right: 8px; }
    .nav-item.active-nav i { color: var(--fb-primary); }
    
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--fb-primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#f0f2f5]">

  <!-- NOTIFICATIONS & OVERLAYS -->
  <div id="toast" class="fixed bottom-5 left-5 z-[100] hidden px-4 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-y-0 font-medium flex items-center gap-2"></div>
  
  <div id="loadingOverlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[90] hidden flex flex-col items-center justify-center">
    <div class="loader mb-2" style="width: 40px; height: 40px;"></div>
    <p class="text-sm text-gray-500 font-medium">กำลังโหลดข้อมูล...</p>
  </div>

  <!-- CAMERA UI -->
  <div id="cameraModal" class="fixed inset-0 bg-black z-[110] hidden flex flex-col">
    <div class="relative flex-1 bg-black flex items-center justify-center overflow-hidden">
      <video id="cameraVideo" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
      <canvas id="cameraCanvas" class="hidden"></canvas>
    </div>
    <div class="h-32 bg-black/80 flex items-center justify-around px-8 pb-6 pt-4 safe-area-bottom">
      <button onclick="closeCamera()" class="p-4 rounded-full bg-gray-800/80 text-white hover:bg-gray-700 transition"><i class="fas fa-times text-xl"></i></button>
      <button onclick="capturePhoto()" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center hover:bg-gray-800 transition active:scale-95"><div class="w-16 h-16 bg-white rounded-full"></div></button>
      <button onclick="switchCamera()" class="p-4 rounded-full bg-gray-800/80 text-white hover:bg-gray-700 transition"><i class="fas fa-sync-alt text-xl"></i></button>
    </div>
  </div>

  <!-- AUTHENTICATION -->
  <div id="authPage" class="min-h-screen flex items-center justify-center p-4 absolute inset-0 z-50 overflow-y-auto bg-[#f0f2f5]">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
      <div class="mb-6">
        <h1 class="text-3xl font-bold text-[#0866ff] mb-2">Inventory System</h1>
        <p class="text-lg text-gray-600">กลุ่มวิจัยเคมีดิน</p>
      </div>
      <form id="loginForm" class="space-y-4">
        <input type="text" id="loginUser" class="w-full border border-gray-300 p-3 rounded-lg focus:border-[#0866ff] focus:ring-1 focus:ring-[#0866ff] outline-none" placeholder="ชื่อผู้ใช้งาน" required>
        <input type="password" id="loginPass" class="w-full border border-gray-300 p-3 rounded-lg focus:border-[#0866ff] focus:ring-1 focus:ring-[#0866ff] outline-none" placeholder="รหัสผ่าน" required>
        <button type="submit" class="w-full bg-[#0866ff] text-white p-3 rounded-lg font-bold text-lg hover:bg-[#1877f2] transition shadow">เข้าสู่ระบบ</button>
        <hr class="my-4 border-gray-300">
        <button type="button" onclick="toggleAuth('register')" class="bg-[#42b72a] text-white px-4 py-3 rounded-lg font-bold hover:bg-[#36a420] transition">สร้างบัญชีใหม่</button>
      </form>
      <form id="registerForm" class="hidden space-y-3 text-left">
        <h2 class="text-xl font-bold mb-4 text-center">สมัครสมาชิก</h2>
        <input type="text" id="regUser" class="w-full border p-2 rounded-lg bg-gray-50" placeholder="Username" required>
        <input type="password" id="regPass" class="w-full border p-2 rounded-lg bg-gray-50" placeholder="Password" required>
        <input type="text" id="regName" class="w-full border p-2 rounded-lg bg-gray-50" placeholder="ชื่อ-นามสกุล" required>
        <input type="text" id="regGroup" class="w-full border p-2 rounded-lg bg-gray-50" placeholder="กลุ่มงาน" required>
        <div class="text-xs text-gray-500 mb-2">เมื่อสมัครแล้วต้องรอ Admin อนุมัติสิทธิ์ก่อนใช้งาน</div>
        <button type="submit" class="w-full bg-[#0866ff] text-white p-2.5 rounded-lg font-bold">สมัครสมาชิก</button>
        <div class="text-center mt-3 text-sm text-[#0866ff] cursor-pointer hover:underline" onclick="toggleAuth('login')">มีบัญชีแล้ว? เข้าสู่ระบบ</div>
      </form>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="mainApp" class="hidden flex flex-col h-full">
    
    <!-- Top Navbar (Facebook Style - Fixed) -->
    <header class="bg-white shadow-sm h-14 flex items-center justify-between px-4 z-40 fixed w-full top-0">
      <!-- Left: Logo & Search -->
      <div class="flex items-center gap-2 md:w-64">
        <div class="w-10 h-10 bg-gradient-to-br from-[#0866ff] to-[#00a4ff] rounded-full flex items-center justify-center text-white font-bold text-xl cursor-pointer" onclick="route('dashboard')">
          <i class="fas fa-flask"></i>
        </div>
        <div class="hidden md:flex relative ml-2 w-full">
          <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
          <input type="text" placeholder="ค้นหา Inventory..." class="fb-input pl-10 w-full" id="globalSearch">
        </div>
        <button class="md:hidden ml-2 text-gray-600" onclick="document.getElementById('mobileMenu').classList.toggle('hidden')">
          <i class="fas fa-bars text-2xl"></i>
        </button>
      </div>

      <!-- Right: Profile -->
      <div class="flex items-center gap-2">
        <div class="hidden md:flex items-center gap-2 cursor-pointer p-1 pr-3 rounded-full hover:bg-gray-100 transition" onclick="logout()">
          <div class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600 border border-gray-300" id="avatarInitials">U</div>
          <span class="font-semibold text-sm" id="headerUserName">User</span>
        </div>
      </div>
    </header>

    <!-- Content Container (Below Navbar) -->
    <div class="flex flex-1 pt-14 overflow-hidden">
      
      <!-- Sidebar (Left - Desktop) -->
      <aside class="w-72 hidden md:flex flex-col fixed h-full pt-4 pb-20 pl-2 pr-2 hover:overflow-y-auto" style="top: 56px; left: 0;">
        <div class="space-y-1">
          <a href="#" onclick="route('dashboard')" class="nav-item active-nav" data-page="dashboard">
            <i class="fas fa-home text-blue-500"></i> <span>ภาพรวม</span>
          </a>
          <a href="#" onclick="route('inventory')" class="nav-item" data-page="inventory">
            <i class="fas fa-box-open text-amber-500"></i> <span>รายการวัสดุ</span>
          </a>
          <div class="border-t my-2 border-gray-300"></div>
          <p class="px-3 py-2 text-xs font-bold text-gray-500 uppercase">เมนูทำรายการ</p>
          <a href="#" onclick="route('withdraw')" class="nav-item" data-page="withdraw">
            <i class="fas fa-hand-holding-box text-rose-500"></i> <span>เบิกวัสดุ</span>
          </a>
          <a href="#" onclick="route('import')" class="nav-item" data-page="import">
            <i class="fas fa-truck-loading text-emerald-500"></i> <span>นำเข้าสต๊อก</span>
          </a>
          <div class="border-t my-2 border-gray-300"></div>
          <p class="px-3 py-2 text-xs font-bold text-gray-500 uppercase">วิเคราะห์ข้อมูล</p>
          <a href="#" onclick="route('reports')" class="nav-item" data-page="reports">
            <i class="fas fa-file-alt text-purple-500"></i> <span>รายงาน & ประวัติ</span>
          </a>
          <div id="adminMenuSection" class="hidden">
            <div class="border-t my-2 border-gray-300"></div>
            <p class="px-3 py-2 text-xs font-bold text-gray-500 uppercase">ผู้ดูแลระบบ</p>
            <a href="#" onclick="route('users')" class="nav-item" data-page="users">
              <i class="fas fa-users-cog text-gray-600"></i> <span>จัดการผู้ใช้</span>
            </a>
            <a href="#" onclick="route('settings')" class="nav-item" data-page="settings">
              <i class="fas fa-cog text-gray-600"></i> <span>ตั้งค่าระบบ</span>
            </a>
          </div>
        </div>
        <div class="mt-auto px-3 pb-4 text-xs text-gray-400">
          <p>Inventory System v1.5</p>
          <p>© กลุ่มวิจัยเคมีดิน</p>
        </div>
      </aside>

      <!-- Mobile Menu Overlay -->
      <div id="mobileMenu" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" onclick="this.classList.add('hidden')">
        <div class="bg-white w-3/4 h-full p-4" onclick="event.stopPropagation()">
          <div class="font-bold text-xl mb-4 text-[#0866ff]">เมนูหลัก</div>
          <div class="space-y-2">
            <a href="#" onclick="route('dashboard')" class="block p-3 rounded-lg hover:bg-gray-100 font-medium">ภาพรวม</a>
            <a href="#" onclick="route('inventory')" class="block p-3 rounded-lg hover:bg-gray-100 font-medium">รายการวัสดุ</a>
            <a href="#" onclick="route('withdraw')" class="block p-3 rounded-lg hover:bg-gray-100 font-medium">เบิกวัสดุ</a>
            <a href="#" onclick="route('import')" class="block p-3 rounded-lg hover:bg-gray-100 font-medium">นำเข้าสต๊อก</a>
            <a href="#" onclick="route('reports')" class="block p-3 rounded-lg hover:bg-gray-100 font-medium">รายงาน</a>
            <div id="mobileAdminMenu" class="hidden border-t pt-2">
              <a href="#" onclick="route('users')" class="block p-3 rounded-lg hover:bg-gray-100 font-medium text-blue-600">จัดการผู้ใช้</a>
            </div>
            <button onclick="logout()" class="w-full text-left p-3 text-red-600 font-bold border-t mt-4">ออกจากระบบ</button>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto p-4 md:p-8 md:ml-72 w-full" id="contentArea">
        <!-- Dynamic Content -->
      </main>

    </div>
  </div>

  <!-- MODALS -->
  <!-- 1. Add Material -->
  <div id="materialModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-lg shadow-2xl relative">
      <div class="p-4 border-b flex justify-between items-center"><h3 class="text-xl font-bold">จัดการวัสดุ</h3><div onclick="closeModal('materialModal')" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-300"><i class="fas fa-times"></i></div></div>
      <form id="materialForm" class="p-4 space-y-4">
        <input type="hidden" id="matId">
        <div><label class="font-semibold text-sm">ชื่อวัสดุ</label><input type="text" id="matName" class="w-full border p-2 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none" required></div>
        <div>
          <label class="font-semibold text-sm">รูปภาพ</label>
          <div class="flex gap-2 mb-2 mt-1">
            <button type="button" onclick="toggleImgInput('file', 'mat')" class="px-3 py-1 bg-gray-100 rounded-full text-xs font-bold hover:bg-gray-200">อัปโหลด</button>
            <button type="button" onclick="toggleImgInput('url', 'mat')" class="px-3 py-1 bg-gray-100 rounded-full text-xs font-bold hover:bg-gray-200">ลิงก์</button>
            <button type="button" onclick="openCamera('mat')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold hover:bg-blue-200"><i class="fas fa-camera"></i> ถ่ายรูป</button>
          </div>
          <div id="matInputFile" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:bg-gray-50 relative h-40 flex items-center justify-center">
            <input type="file" id="matImgFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(this, 'mat')">
            <div id="matPreview" class="hidden absolute inset-0 bg-contain bg-center bg-no-repeat rounded-xl"></div>
            <div id="matPlaceholder" class="text-gray-400 text-sm flex flex-col items-center"><i class="fas fa-image text-3xl mb-2"></i><span>เพิ่มรูปภาพ</span></div>
          </div>
          <input type="url" id="matImgUrl" class="hidden w-full border p-2 rounded-lg" placeholder="https://...">
        </div>
        <button type="submit" class="w-full fb-btn py-2.5">บันทึก</button>
      </form>
    </div>
  </div>

  <!-- 2. Transaction -->
  <div id="transModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-md shadow-2xl relative">
      <div class="p-4 border-b flex justify-between items-center"><h3 id="transModalTitle" class="text-xl font-bold">ทำรายการ</h3><div onclick="closeModal('transModal')" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-300"><i class="fas fa-times"></i></div></div>
      <form id="transForm" class="p-4 space-y-4">
        <input type="hidden" id="transType">
        <input type="hidden" id="transMatId">
        <input type="hidden" id="transMatName">
        <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-lg">
          <img id="transImgPreview" class="w-16 h-16 object-cover rounded-lg bg-gray-200 shadow-sm">
          <div><p class="font-bold text-lg" id="transMatNameDisplay">Material</p><p class="text-sm text-gray-500">คงเหลือ: <span id="transCurrentQty" class="font-bold text-blue-600">0</span></p></div>
        </div>
        <div class="flex items-center justify-center gap-4">
          <button type="button" onclick="adjQty(-1)" class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 font-bold text-xl">-</button>
          <input type="number" id="transQty" class="w-20 text-center text-2xl font-bold border-none outline-none bg-transparent" min="1" value="1" required>
          <button type="button" onclick="adjQty(1)" class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 font-bold text-xl">+</button>
        </div>
        <div id="importFields" class="hidden space-y-3 p-3 bg-blue-50 rounded-lg">
          <div><label class="text-xs font-bold text-blue-800 uppercase">วันที่ (ย้อนหลังได้)</label><input type="date" id="transDate" class="w-full border border-blue-200 p-2 rounded-lg bg-white"></div>
          <div><label class="text-xs font-bold text-blue-800 uppercase">อ้างอิงเอกสาร</label><input type="text" id="transRef" class="w-full border border-blue-200 p-2 rounded-lg bg-white"></div>
        </div>
        <div>
          <label class="font-semibold text-sm">หลักฐานรูปภาพ (ถ้ามี)</label>
          <div class="flex gap-2 mt-1">
            <button type="button" onclick="openCamera('trans')" class="px-3 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200"><i class="fas fa-camera"></i> ถ่ายรูป</button>
            <label class="px-3 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200 cursor-pointer">
              <input type="file" id="transProofFile" accept="image/*" class="hidden" onchange="previewImage(this, 'trans')"> เลือกไฟล์
            </label>
          </div>
          <div id="transPreview" class="hidden h-32 w-full mt-2 bg-contain bg-center bg-no-repeat rounded-lg border border-gray-200"></div>
          <div id="transPlaceholder" class="hidden"></div> <!-- Placeholder logic fix -->
        </div>
        <button type="submit" id="btnTransSubmit" class="w-full fb-btn py-3 text-lg shadow-md">ยืนยัน</button>
      </form>
    </div>
  </div>

  <!-- 3. Upload Proof Later -->
  <div id="proofModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[80] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-sm shadow-2xl relative">
      <div class="p-4 border-b flex justify-between items-center"><h3 class="font-bold">แนบรูปย้อนหลัง</h3><div onclick="closeModal('proofModal')" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-300"><i class="fas fa-times"></i></div></div>
      <form id="proofForm" class="p-4 space-y-4">
        <input type="hidden" id="proofTxId">
        <input type="hidden" id="proofType">
        <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:bg-gray-50 relative h-48 flex flex-col items-center justify-center">
          <input type="file" id="proofFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(this, 'proof')">
          <div id="proofPreview" class="hidden absolute inset-0 bg-contain bg-center bg-no-repeat rounded-xl"></div>
          <div id="proofPlaceholder" class="text-gray-400">
            <i class="fas fa-cloud-upload-alt text-4xl mb-2"></i>
            <p class="text-sm">แตะเพื่อเลือกรูป</p>
            <button type="button" onclick="openCamera('proof'); event.preventDefault();" class="mt-3 px-4 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold z-10 relative">หรือถ่ายรูป</button>
          </div>
        </div>
        <button type="submit" class="w-full fb-btn py-2">อัปโหลด</button>
      </form>
    </div>
  </div>

  <!-- 4. Manage User Permissions Modal -->
  <div id="userPermModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[80] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-md shadow-2xl relative">
      <div class="p-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg">กำหนดสิทธิ์ผู้ใช้งาน</h3><div onclick="closeModal('userPermModal')" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-300"><i class="fas fa-times"></i></div></div>
      <div class="p-6">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xl" id="permUserInitials">U</div>
          <div>
            <h4 class="font-bold text-lg" id="permUserName">Username</h4>
            <p class="text-sm text-gray-500" id="permUserGroup">Group</p>
          </div>
        </div>
        <input type="hidden" id="permUserId">
        <div class="space-y-3">
          <label class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <span class="font-medium"><i class="fas fa-eye text-gray-400 w-6"></i> ดูรายการวัสดุ (View)</span>
            <input type="checkbox" class="w-5 h-5 accent-blue-600" id="perm_view_stock" checked disabled>
          </label>
          <label class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <span class="font-medium"><i class="fas fa-hand-holding-box text-rose-500 w-6"></i> เบิกวัสดุ (Withdraw)</span>
            <input type="checkbox" class="w-5 h-5 accent-blue-600" id="perm_withdraw_material">
          </label>
          <label class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <span class="font-medium"><i class="fas fa-truck-loading text-emerald-500 w-6"></i> นำเข้าสต๊อก (Import)</span>
            <input type="checkbox" class="w-5 h-5 accent-blue-600" id="perm_import_material">
          </label>
          <label class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <span class="font-medium"><i class="fas fa-edit text-amber-500 w-6"></i> จัดการรายการ (Add/Edit)</span>
            <input type="checkbox" class="w-5 h-5 accent-blue-600" id="perm_manage_material">
          </label>
        </div>
        <button onclick="savePermissions()" class="w-full fb-btn py-3 mt-6">บันทึกการเปลี่ยนแปลง</button>
      </div>
    </div>
  </div>

  <!-- JS LOGIC -->
  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxdK7zgf3YLbUPUEEgBhfe2jP2g6J4jvgGLhNUJnTd4WGlL9OJUVL5wJFBI6iMV9d4o/exec";
    const state = { user: null, materials: [], reports: { withdraw: [], import: [] }, users: [], pagination: { currentPage: 1, itemsPerPage: 12, totalPages: 1 }, filter: { search: '', sort: 'newest' } };
    let stockChartInstance, statusChartInstance, videoStream, currentFacingMode = 'environment', currentCamTarget = '';

    // --- CACHING & API ---
    // Simple in-memory cache to prevent re-fetching on every tab switch
    const cache = { materials: null, users: null, reports: null };

    async function api(action, payload = {}) {
      // Optimistic UI: Don't show full loading overlay for every action if we can avoid it
      const showOverlay = !['getMaterials', 'getReports'].includes(action) || !cache.materials; 
      if(showOverlay) document.getElementById('loadingOverlay').classList.remove('hidden');
      
      try {
        let result;
        if (typeof google !== 'undefined' && google.script) {
          result = await new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler(res => res.success ? resolve(res.data) : reject(new Error(res.error))).withFailureHandler(reject).apiHandler({ action, payload });
          });
        } else {
          const res = await fetch(WEB_APP_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action, payload }) });
          const json = await res.json();
          if(!json.success) throw new Error(json.error);
          result = json.data;
        }
        if(showOverlay) document.getElementById('loadingOverlay').classList.add('hidden');
        return result;
      } catch (err) {
        if(showOverlay) document.getElementById('loadingOverlay').classList.add('hidden');
        showToast(err.message, 'error');
        throw err;
      }
    }

    // --- AUTH ---
    function initApp() {
      const savedUser = localStorage.getItem('user_session');
      if (savedUser) { state.user = JSON.parse(savedUser); setupUI(); route('dashboard'); } 
      else { document.getElementById('authPage').classList.remove('hidden'); }
    }
    function setupUI() {
      document.getElementById('authPage').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('headerUserName').innerText = state.user.fullname.split(' ')[0]; 
      document.getElementById('avatarInitials').innerText = state.user.fullname.charAt(0);
      
      // Permission Check for Menu
      const isAdmin = state.user.role === 'admin';
      if(isAdmin) document.getElementById('adminMenuSection').classList.remove('hidden');
      if(isAdmin) document.getElementById('mobileAdminMenu').classList.remove('hidden');
    }
    
    document.getElementById('loginForm').onsubmit = async (e) => { e.preventDefault(); try { state.user = await api('login', { username: document.getElementById('loginUser').value, password: document.getElementById('loginPass').value }); localStorage.setItem('user_session', JSON.stringify(state.user)); setupUI(); route('dashboard'); } catch(e) {} };
    function logout() { localStorage.removeItem('user_session'); location.reload(); }
    function toggleAuth(mode) { document.getElementById('loginForm').classList.toggle('hidden', mode === 'register'); document.getElementById('registerForm').classList.toggle('hidden', mode !== 'register'); }

    // --- ROUTING ---
    async function route(page) {
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav'));
      const activeBtn = document.querySelector(`.nav-item[data-page="${page}"]`);
      if(activeBtn) activeBtn.classList.add('active-nav');
      
      const content = document.getElementById('contentArea');
      document.getElementById('mobileMenu').classList.add('hidden'); // Auto close mobile menu

      // Destroy charts to prevent hanging
      if (stockChartInstance) { stockChartInstance.destroy(); stockChartInstance = null; }
      if (statusChartInstance) { statusChartInstance.destroy(); statusChartInstance = null; }

      switch(page) {
        case 'dashboard': renderDashboard(content); break;
        case 'inventory': renderInventory(content, 'view'); break;
        case 'withdraw': renderInventory(content, 'withdraw'); break;
        case 'import': renderInventory(content, 'import'); break;
        case 'reports': renderReports(content); break;
        case 'users': renderUsers(content); break;
        case 'settings': renderSettings(content); break;
      }
    }

    // --- DASHBOARD ---
    async function renderDashboard(c) {
      c.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">${cardSkeleton().repeat(4)}</div><div class="grid grid-cols-1 lg:grid-cols-3 gap-4"><div class="lg:col-span-2 h-72 bg-white rounded-lg shadow-sm border border-gray-100 skeleton"></div><div class="h-72 bg-white rounded-lg shadow-sm border border-gray-100 skeleton"></div></div>`;
      try {
        // Cache Strategy: Use cache if available, else fetch
        if(!cache.materials) cache.materials = await api('getMaterials');
        state.materials = cache.materials;
        
        const total = state.materials.length;
        const stock = state.materials.reduce((s, m) => s + parseInt(m.qty||0), 0);
        const low = state.materials.filter(m => parseInt(m.qty||0)<5).length;
        const last = state.materials.length ? formatDate(state.materials[state.materials.length-1].last_import_date).split(' ')[0] : '-';
        
        c.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 fade-in">
            ${statCard('รายการทั้งหมด', total, 'fas fa-box', 'text-blue-600', 'bg-blue-50')} 
            ${statCard('จำนวนคงเหลือ', stock, 'fas fa-layer-group', 'text-emerald-600', 'bg-emerald-50')}
            ${statCard('ใกล้หมด (<5)', low, 'fas fa-exclamation-triangle', 'text-amber-600', 'bg-amber-50')} 
            ${statCard('อัปเดตล่าสุด', last, 'fas fa-clock', 'text-purple-600', 'bg-purple-50')}
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
            <div class="fb-card p-6 lg:col-span-2"><h3 class="font-bold text-gray-700 mb-4">Top 10 คงเหลือ</h3><div class="relative h-64 w-full"><canvas id="stockChart"></canvas></div></div>
            <div class="fb-card p-6"><h3 class="font-bold text-gray-700 mb-4">สถานะภาพรวม</h3><div class="relative h-48 w-full"><canvas id="statusChart"></canvas></div></div>
          </div>`;
          
        const top = [...state.materials].sort((a,b)=>b.qty-a.qty).slice(0,10);
        const ctx1 = document.getElementById('stockChart');
        if(ctx1) {
          stockChartInstance = new Chart(ctx1, { type: 'bar', data: { labels: top.map(m=>m.name.substring(0,12)+'...'), datasets: [{ label: 'จำนวน', data: top.map(m=>m.qty), backgroundColor: '#0866ff', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } } } });
        }
        const ctx2 = document.getElementById('statusChart');
        if(ctx2) {
          statusChartInstance = new Chart(ctx2, { type: 'doughnut', data: { labels: ['ปกติ', 'ใกล้หมด', 'หมด'], datasets: [{ data: [total-low-state.materials.filter(m=>m.qty==0).length, low, state.materials.filter(m=>m.qty==0).length], backgroundColor: ['#36a420', '#f7b928', '#fa3e3e'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } } });
        }
      } catch(e) { c.innerHTML = `<div class="text-center text-red-500 p-8">Error loading dashboard</div>`; }
    }

    // --- INVENTORY ---
    async function renderInventory(c, mode) {
      const perms = state.user.permissions || [];
      const isAdmin = state.user.role === 'admin';
      const canManage = isAdmin || perms.includes('manage_material');
      const canWithdraw = isAdmin || perms.includes('withdraw_material');
      const canImport = isAdmin || perms.includes('import_material');

      // Check permissions before rendering action views
      if(mode === 'withdraw' && !canWithdraw) return c.innerHTML = permissionDeniedHTML();
      if(mode === 'import' && !canImport) return c.innerHTML = permissionDeniedHTML();

      c.innerHTML = `
      <div class="flex flex-col h-full gap-4 fade-in">
        <div class="fb-card p-4 flex flex-col md:flex-row gap-4 justify-between items-center sticky top-0 z-10">
          <div class="relative w-full md:w-80">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="ค้นหาวัสดุ..." class="fb-input w-full pl-10" onkeyup="handleSearch()">
          </div>
          <div class="flex gap-2 w-full md:w-auto">
            ${mode==='view' && canManage ? `<button onclick="openMaterialModal()" class="fb-btn px-4 py-2 flex-1 md:flex-none"><i class="fas fa-plus"></i> เพิ่มวัสดุ</button>` : ''}
            <button onclick="refreshData('materials')" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-200"><i class="fas fa-sync-alt"></i></button>
          </div>
        </div>
        <div id="inventoryContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
          ${cardSkeleton().repeat(4)}
        </div>
      </div>`;
      
      if(!cache.materials) cache.materials = await api('getMaterials');
      state.materials = cache.materials;
      renderMaterialList(mode);
    }

    function renderMaterialList(mode) {
      const container = document.getElementById('inventoryContainer');
      const filtered = state.materials.filter(m=>m.name.toLowerCase().includes(state.filter.search.toLowerCase())).sort((a,b)=>b.qty-a.qty); // Default sort by qty high to low
      
      if(!filtered.length) { container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400"><i class="fas fa-box-open text-4xl mb-2"></i><p>ไม่พบข้อมูล</p></div>'; return; }

      const perms = state.user.permissions || [];
      const isAdmin = state.user.role === 'admin';
      const canManage = isAdmin || perms.includes('manage_material');

      container.innerHTML = filtered.map(m => `
        <div class="fb-card overflow-hidden flex flex-col group relative">
          <div class="h-40 bg-gray-100 relative overflow-hidden">
            <img src="${m.image_url||'https://via.placeholder.com/300'}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
            ${m.qty < 5 ? `<div class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-md shadow">ใกล้หมด</div>` : ''}
          </div>
          <div class="p-4 flex-1 flex flex-col">
            <h4 class="font-bold text-gray-800 mb-1 line-clamp-1" title="${m.name}">${m.name}</h4>
            <div class="mt-auto flex justify-between items-end">
              <span class="text-xs text-gray-400">ID: ${m.material_id.slice(-4)}</span>
              <span class="text-2xl font-bold text-[#0866ff]">${m.qty} <span class="text-sm font-normal text-gray-500">ชิ้น</span></span>
            </div>
          </div>
          <div class="p-2 border-t bg-gray-50">
            ${mode==='view' && canManage ? 
              `<div class="flex gap-2">
                <button onclick='openMaterialModal(${JSON.stringify(m)})' class="flex-1 py-1.5 text-xs bg-white border border-gray-300 rounded text-gray-600 hover:text-[#0866ff] hover:border-[#0866ff]">แก้ไข</button>
                <button onclick="deleteMaterial('${m.material_id}')" class="flex-1 py-1.5 text-xs bg-white border border-gray-300 rounded text-gray-600 hover:text-red-500 hover:border-red-500">ลบ</button>
              </div>` : 
              `<button onclick='openTransModal("${mode}",${JSON.stringify(m)})' class="w-full py-2 ${mode==='import'?'bg-[#42b72a] hover:bg-[#36a420]':'bg-red-500 hover:bg-red-600'} text-white rounded font-bold shadow-sm">${mode==='import'?'นำเข้า':'เบิกออก'}</button>`
            }
          </div>
        </div>`).join('');
    }

    // --- REPORTS ---
    async function renderReports(c) {
      c.innerHTML = `
        <div class="fb-card p-4 mb-4 flex flex-col md:flex-row gap-4 justify-between items-center fade-in">
          <h2 class="text-xl font-bold text-gray-700">ประวัติการทำรายการ</h2>
          <div class="flex gap-2 flex-wrap justify-end items-center w-full md:w-auto">
            <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1 px-2">
              <span class="text-xs font-bold text-gray-500">วันที่:</span>
              <input type="date" id="filterStartDate" class="bg-transparent border-none text-sm outline-none w-32" onchange="filterReports()">
              <span class="text-gray-400">-</span>
              <input type="date" id="filterEndDate" class="bg-transparent border-none text-sm outline-none w-32" onchange="filterReports()">
            </div>
            <button onclick="refreshData('reports')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600"><i class="fas fa-sync-alt text-xs"></i></button>
            <button onclick="exportCSV()" class="px-3 py-1.5 bg-gray-800 text-white rounded text-sm hover:bg-gray-900"><i class="fas fa-file-csv"></i> CSV</button>
            <button onclick="exportPDF()" class="px-3 py-1.5 bg-red-600 text-white rounded text-sm hover:bg-red-700"><i class="fas fa-file-pdf"></i> PDF</button>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-200px)] fade-in">
          <div class="fb-card flex flex-col overflow-hidden">
            <div class="p-3 bg-red-50 border-b border-red-100 text-red-700 font-bold flex justify-between"><span>ประวัติการเบิก</span><i class="fas fa-arrow-down"></i></div>
            <div class="overflow-y-auto flex-1 p-0 custom-scroll" id="withdrawLog"></div>
          </div>
          <div class="fb-card flex flex-col overflow-hidden">
            <div class="p-3 bg-green-50 border-b border-green-100 text-green-700 font-bold flex justify-between"><span>ประวัติการนำเข้า</span><i class="fas fa-arrow-up"></i></div>
            <div class="overflow-y-auto flex-1 p-0 custom-scroll" id="importLog"></div>
          </div>
        </div>`;
      
      if(!cache.reports) cache.reports = await api('getReports');
      state.reports = cache.reports;
      filterReports(); // Initial render with logic
    }

    function filterReports() {
      const startStr = document.getElementById('filterStartDate')?.value;
      const endStr = document.getElementById('filterEndDate')?.value;
      const startDate = startStr ? new Date(startStr) : null;
      const endDate = endStr ? new Date(endStr) : null;
      if(endDate) endDate.setHours(23,59,59);

      const filterFn = (item) => {
        if(!startDate && !endDate) return true;
        const itemDate = new Date(item.timestamp);
        if(startDate && itemDate < startDate) return false;
        if(endDate && itemDate > endDate) return false;
        return true;
      };

      const wData = state.reports.withdraw.filter(filterFn);
      const iData = state.reports.import.filter(filterFn);

      document.getElementById('withdrawLog').innerHTML = renderLogTable(wData, 'withdraw', 'text-red-600');
      document.getElementById('importLog').innerHTML = renderLogTable(iData, 'import', 'text-green-600');
    }

    function renderLogTable(data, type, colorClass) {
      if(!data.length) return `<div class="p-8 text-center text-gray-400 text-sm">ไม่พบข้อมูลในช่วงเวลานี้</div>`;
      return `<table class="w-full text-sm text-left">
        <thead class="bg-gray-50 text-gray-500 font-medium sticky top-0"><tr><th class="p-3 pl-4">วันที่/เวลา</th><th class="p-3">รายการ</th><th class="p-3 text-right">จำนวน</th><th class="p-3 text-center">หลักฐาน</th></tr></thead>
        <tbody class="divide-y divide-gray-100">` +
        data.map(r => {
          const hasProof = r.proof_url && r.proof_url.length > 5;
          const isMe = r.user_name === state.user.fullname;
          let proofEl = '-';
          if (hasProof) proofEl = `<a href="${r.proof_url}" target="_blank" class="text-[#0866ff] hover:underline bg-blue-50 px-2 py-1 rounded-full text-xs">ดูรูป</a>`;
          else if (isMe && r.transaction_id) proofEl = `<button onclick="openProofModal('${r.transaction_id}', '${type}')" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 text-gray-600"><i class="fas fa-camera"></i></button>`;
          
          return `<tr class="hover:bg-gray-50 transition">
            <td class="p-3 pl-4">
              <div class="font-semibold text-gray-700">${formatDate(r.timestamp).split(' ')[0]}</div>
              <div class="text-xs text-gray-400">${formatDate(r.timestamp).split(' ')[1]} โดย ${r.user_name.split(' ')[0]}</div>
            </td>
            <td class="p-3 text-gray-600">${r.material_name}</td>
            <td class="p-3 text-right font-bold ${colorClass}">${r.qty}</td>
            <td class="p-3 text-center">${proofEl}</td>
          </tr>`;
        }).join('') + `</tbody></table>`;
    }

    // --- USERS (Admin Only) ---
    async function renderUsers(c) {
      if(state.user.role !== 'admin') return c.innerHTML = permissionDeniedHTML();
      c.innerHTML = `
        <div class="fb-card overflow-hidden fade-in">
          <div class="p-4 border-b flex justify-between items-center bg-gray-50">
            <h3 class="font-bold text-gray-700">จัดการผู้ใช้งาน</h3>
            <button onclick="refreshData('users')" class="text-gray-500 hover:text-blue-600"><i class="fas fa-sync-alt"></i></button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="bg-gray-100 text-gray-600 font-semibold border-b">
                <tr><th class="p-4">User</th><th class="p-4">Name</th><th class="p-4">Status</th><th class="p-4">Role</th><th class="p-4">จัดการ</th></tr>
              </thead>
              <tbody id="userTableBody" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
        </div>`;
      
      if(!cache.users) cache.users = await api('getUsers');
      state.users = cache.users;
      
      document.getElementById('userTableBody').innerHTML = state.users.map(u => `
        <tr class="hover:bg-gray-50">
          <td class="p-4 font-medium text-gray-700">${u.username}</td>
          <td class="p-4"><div>${u.fullname}</div><div class="text-xs text-gray-400">${u.group}</div></td>
          <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${u.status === 'approved' ? 'bg-green-100 text-green-700' : u.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${u.status}</span></td>
          <td class="p-4 uppercase text-xs font-bold text-gray-500">${u.role}</td>
          <td class="p-4 flex gap-2">
            ${u.status === 'pending' ? 
              `<button onclick="updateUserStatus('${u.user_id}', 'approved')" class="text-green-600 bg-green-50 px-3 py-1 rounded hover:bg-green-100 font-bold text-xs">อนุมัติ</button>
               <button onclick="updateUserStatus('${u.user_id}', 'rejected')" class="text-red-600 bg-red-50 px-3 py-1 rounded hover:bg-red-100 font-bold text-xs">ปฏิเสธ</button>` : 
              `<button onclick='openUserPermModal(${JSON.stringify(u)})' class="text-blue-600 bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 font-bold text-xs"><i class="fas fa-key"></i> สิทธิ์</button>`}
          </td>
        </tr>`).join('');
    }

    // --- MODAL & LOGIC FOR PERMISSIONS ---
    function openUserPermModal(user) {
      document.getElementById('permUserId').value = user.user_id;
      document.getElementById('permUserName').innerText = user.fullname;
      document.getElementById('permUserGroup').innerText = user.group;
      document.getElementById('permUserInitials').innerText = user.fullname.charAt(0);
      
      // Parse permissions (array of strings)
      let perms = [];
      try { perms = typeof user.permissions === 'string' ? JSON.parse(user.permissions) : user.permissions || []; } catch(e) { perms = []; }
      
      document.getElementById('perm_view_stock').checked = true; // Always true
      document.getElementById('perm_withdraw_material').checked = perms.includes('withdraw_material');
      document.getElementById('perm_import_material').checked = perms.includes('import_material');
      document.getElementById('perm_manage_material').checked = perms.includes('manage_material');
      
      document.getElementById('userPermModal').classList.remove('hidden');
    }

    async function savePermissions() {
      const uid = document.getElementById('permUserId').value;
      const newPerms = ['view_stock'];
      if(document.getElementById('perm_withdraw_material').checked) newPerms.push('withdraw_material');
      if(document.getElementById('perm_import_material').checked) newPerms.push('import_material');
      if(document.getElementById('perm_manage_material').checked) newPerms.push('manage_material');
      
      try {
        await api('updateUserStatus', { user_id: uid, permissions: newPerms }); // Reuse update endpoint but ensure backend handles perms
        closeModal('userPermModal');
        refreshData('users');
        showToast('บันทึกสิทธิ์เรียบร้อย');
      } catch(e) {}
    }

    async function updateUserStatus(uid, status) {
      if(!confirm('ยืนยันการเปลี่ยนสถานะ?')) return;
      await api('updateUserStatus', { user_id: uid, status: status });
      refreshData('users');
    }

    // --- SHARED UTILS ---
    async function refreshData(key) {
      cache[key] = null; // Clear cache
      if(key==='materials') {
        renderInventory(document.getElementById('contentArea'), 'view'); // Or current view
        // Ideally maintain current view, simplified here
        const currentMode = document.querySelector('.bg-emerald-500') ? 'import' : document.querySelector('.bg-red-500') ? 'withdraw' : 'view';
        renderInventory(document.getElementById('contentArea'), currentMode);
      }
      else if(key==='reports') renderReports(document.getElementById('contentArea'));
      else if(key==='users') renderUsers(document.getElementById('contentArea'));
      showToast('อัปเดตข้อมูลแล้ว');
    }

    // Modal & Form Handlers
    function toggleImgInput(type, prefix) {
      const elFile = document.getElementById(prefix+'InputFile');
      const elUrl = document.getElementById(prefix+'ImgUrl');
      if(type==='file') { if(elFile) elFile.classList.remove('hidden'); if(elUrl) elUrl.classList.add('hidden'); } 
      else { if(elFile) elFile.classList.add('hidden'); if(elUrl) elUrl.classList.remove('hidden'); }
    }

    function previewImage(input, prefix) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById(prefix+'Preview').style.backgroundImage = `url(${e.target.result})`;
          document.getElementById(prefix+'Preview').classList.remove('hidden');
          const placeholder = document.getElementById(prefix+'Placeholder');
          if(placeholder) placeholder.classList.add('hidden');
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    function openMaterialModal(mat = null) {
      document.getElementById('materialForm').reset();
      toggleImgInput('file', 'mat');
      document.getElementById('matPreview').classList.add('hidden');
      document.getElementById('matPlaceholder').classList.remove('hidden');
      if (mat) {
        document.getElementById('matId').value = mat.material_id;
        document.getElementById('matName').value = mat.name;
        document.getElementById('matImgUrl').value = mat.image_url;
      } else {
        document.getElementById('matId').value = '';
      }
      document.getElementById('materialModal').classList.remove('hidden');
    }

    function openTransModal(type, mat) {
      document.getElementById('transForm').reset();
      document.getElementById('transType').value = type;
      document.getElementById('transMatId').value = mat.material_id;
      document.getElementById('transMatName').value = mat.name;
      document.getElementById('transMatNameDisplay').innerText = mat.name;
      document.getElementById('transCurrentQty').innerText = mat.qty;
      document.getElementById('transImgPreview').src = mat.image_url || 'https://via.placeholder.com/64?text=Img';
      
      document.getElementById('transDate').valueAsDate = new Date();
      
      const isImport = type === 'import';
      document.getElementById('transModalTitle').innerText = isImport ? 'นำเข้าสต๊อก' : 'เบิกวัสดุ';
      document.getElementById('btnTransSubmit').className = `w-full py-3 rounded-lg font-bold text-white shadow-md transition ${isImport ? 'bg-[#42b72a] hover:bg-[#36a420]' : 'bg-red-500 hover:bg-red-600'}`;
      document.getElementById('btnTransSubmit').innerText = isImport ? 'ยืนยันการนำเข้า' : 'ยืนยันการเบิก';
      
      document.getElementById('importFields').classList.toggle('hidden', !isImport);
      document.getElementById('transModal').classList.remove('hidden');
    }
    
    function openProofModal(txId, type) {
      document.getElementById('proofForm').reset();
      document.getElementById('proofPreview').classList.add('hidden');
      document.getElementById('proofPlaceholder').classList.remove('hidden');
      document.getElementById('proofTxId').value = txId; 
      document.getElementById('proofType').value = type;
      document.getElementById('proofModal').classList.remove('hidden');
    }

    function adjQty(delta) {
      const el = document.getElementById('transQty');
      const val = parseInt(el.value) || 0;
      if(val + delta >= 1) el.value = val + delta;
    }

    // Submit Handlers
    document.getElementById('materialForm').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('matId').value;
      const fileInput = document.getElementById('matImgFile');
      let payload = {
        name: document.getElementById('matName').value,
        image_url: document.getElementById('matImgUrl').value
      };
      
      if (fileInput.files.length > 0) {
        const reader = new FileReader();
        payload.image_data = await new Promise(r => { reader.onload = e => r(e.target.result); reader.readAsDataURL(fileInput.files[0]); });
      }

      try {
        // Optimistic UI Update (Simplified: just close and wait for reload or add logic to push to local array)
        // For simplicity with speed feeling: Close modal immediately, show loading spinner only briefly
        closeModal('materialModal');
        await api(id ? 'updateMaterial' : 'addMaterial', { ...payload, material_id: id });
        cache.materials = null; // Invalidate cache
        renderInventory(document.getElementById('contentArea'), 'view');
        showToast('บันทึกข้อมูลสำเร็จ');
      } catch(e) {}
    };

    document.getElementById('transForm').onsubmit = async (e) => {
      e.preventDefault();
      const type = document.getElementById('transType').value;
      const dateStr = document.getElementById('transDate').value;
      const rawRef = document.getElementById('transRef').value;
      const combinedRef = (type === 'import' && dateStr) ? `[Date: ${dateStr}] ${rawRef}` : rawRef;
      
      const fileInput = document.getElementById('transProofFile');
      let imageData = null;
      if (fileInput.files.length > 0) {
        const reader = new FileReader();
        imageData = await new Promise(r => { reader.onload = e => r(e.target.result); reader.readAsDataURL(fileInput.files[0]); });
      }

      const qty = parseInt(document.getElementById('transQty').value);
      const matId = document.getElementById('transMatId').value;

      // Optimistic UI: Update local state immediately
      const matIndex = state.materials.findIndex(m => m.material_id === matId);
      if(matIndex > -1) {
        if(type === 'import') state.materials[matIndex].qty = parseInt(state.materials[matIndex].qty) + qty;
        else state.materials[matIndex].qty = Math.max(0, parseInt(state.materials[matIndex].qty) - qty);
      }
      closeModal('transModal');
      renderMaterialList(type); // Re-render with new qty immediately
      
      try {
        // Send to backend in background
        await api(type === 'import' ? 'importMaterial' : 'withdrawMaterial', {
          material_id: matId,
          material_name: document.getElementById('transMatName').value,
          qty: qty,
          user_name: state.user.fullname,
          ref_doc: combinedRef,
          image_data: imageData
        });
        cache.reports = null; // Invalidate reports cache
        showToast('ทำรายการสำเร็จ');
      } catch(e) {
        // Revert on error
        if(matIndex > -1) {
           if(type === 'import') state.materials[matIndex].qty -= qty;
           else state.materials[matIndex].qty += qty;
        }
        renderMaterialList(type);
        showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
      }
    };
    
    document.getElementById('proofForm').onsubmit = async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('proofFile');
      let imageData = null;
      if (fileInput.files.length > 0) {
        const reader = new FileReader();
        imageData = await new Promise(r => { reader.onload = e => r(e.target.result); reader.readAsDataURL(fileInput.files[0]); });
      } else return showToast('กรุณาเลือกรูปภาพ', 'error');
      
      try {
        closeModal('proofModal');
        await api('uploadProof', {
          transaction_id: document.getElementById('proofTxId').value,
          type: document.getElementById('proofType').value,
          user_name: state.user.fullname,
          image_data: imageData
        });
        cache.reports = null;
        renderReports(document.getElementById('contentArea'));
        showToast('อัปโหลดรูปภาพสำเร็จ');
      } catch(e) {}
    };

    // Camera Functions
    async function openCamera(target) {
      currentCamTarget = target;
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('cameraVideo');
      modal.classList.remove('hidden');
      try { videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } }); video.srcObject = videoStream; } catch(e) { alert('Camera Error'); closeCamera(); }
    }
    function switchCamera() { if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); currentFacingMode = currentFacingMode==='environment'?'user':'environment'; openCamera(currentCamTarget); }
    function closeCamera() { document.getElementById('cameraModal').classList.add('hidden'); if(videoStream) { videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; } }
    function capturePhoto() {
      const video = document.getElementById('cameraVideo'); const canvas = document.getElementById('cameraCanvas');
      const w=800, scale=w/video.videoWidth, h=video.videoHeight*scale;
      canvas.width=w; canvas.height=h; canvas.getContext('2d').drawImage(video,0,0,w,h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      
      fetch(dataUrl).then(r=>r.blob()).then(blob=>{
        const f = new File([blob], "cam.jpg", { type: "image/jpeg" });
        const dt = new DataTransfer(); dt.items.add(f);
        let targetId = currentCamTarget === 'mat' ? 'matImgFile' : currentCamTarget === 'trans' ? 'transProofFile' : 'proofFile';
        const fileInput = document.getElementById(targetId);
        if(fileInput) { 
          fileInput.files = dt.files;
          if(currentCamTarget === 'mat') toggleImgInput('file', 'mat');
          const reader = new FileReader();
          reader.onload = e => {
             const pId = currentCamTarget === 'mat' ? 'matPreview' : currentCamTarget === 'trans' ? 'transPreview' : 'proofPreview';
             const phId = currentCamTarget === 'mat' ? 'matPlaceholder' : currentCamTarget === 'trans' ? 'transPlaceholder' : 'proofPlaceholder';
             document.getElementById(pId).style.backgroundImage = `url(${e.target.result})`;
             document.getElementById(pId).classList.remove('hidden');
             if(document.getElementById(phId)) document.getElementById(phId).classList.add('hidden');
          };
          reader.readAsDataURL(f);
        }
      });
      closeCamera();
    }

    // Export PDF/CSV
    function exportPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.addFont("Kanit-Regular.ttf", "Kanit", "normal"); doc.setFontSize(16); doc.text("Stock Report", 14, 20); doc.setFontSize(10); const rows = [...state.reports.withdraw.map(r=>[formatDate(r.timestamp), 'Withdraw', r.material_name, r.qty, r.user_name]), ...state.reports.import.map(r=>[formatDate(r.timestamp), 'Import', r.material_name, r.qty, r.user_name])]; doc.autoTable({ head: [['Date', 'Type', 'Item', 'Qty', 'User']], body: rows, startY: 30 }); doc.save('report.pdf'); }
    function exportCSV() { const data = [...state.reports.withdraw.map(x=>({...x, type:'withdraw'})), ...state.reports.import.map(x=>({...x, type:'import'}))]; if(!data.length) return showToast('No data'); const csv = "Date,Type,Item,Qty,User\n" + data.map(e=>`${formatDate(e.timestamp)},${e.type},${e.material_name},${e.qty},${e.user_name}`).join("\n"); const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8,"+csv); link.download = "report.csv"; document.body.appendChild(link); link.click(); }

    async function deleteMaterial(id) { if(confirm('ยืนยันการลบ?')) { await api('deleteMaterial', { material_id: id }); cache.materials=null; renderInventory(document.getElementById('contentArea'), 'view'); showToast('ลบรายการสำเร็จ'); } }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function showToast(msg, type='success') { const t = document.getElementById('toast'); t.innerHTML = type==='success' ? `<i class="fas fa-check-circle"></i> ${msg}` : `<i class="fas fa-exclamation-circle"></i> ${msg}`; t.className = `fixed bottom-5 left-5 z-[100] px-4 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-y-0 font-medium flex items-center gap-2 ${type==='success'?'bg-gray-800':'bg-red-600'}`; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 3000); }
    function formatDate(d) { if(!d) return '-'; const dt = new Date(d); if(isNaN(dt)) return '-'; return dt.toLocaleDateString('th-TH') + ' ' + dt.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}); }
    function cardSkeleton() { return `<div class="fb-card p-6 h-32 skeleton"></div>`; }
    function statCard(t,v,i,tc,bc) { return `<div class="fb-card p-4 flex items-center justify-between"><div><p class="text-gray-500 text-sm mb-1">${t}</p><p class="text-2xl font-bold text-gray-800">${v}</p></div><div class="w-12 h-12 rounded-full ${bc} flex items-center justify-center ${tc} text-xl"><i class="${i}"></i></div></div>`; }
    function permissionDeniedHTML() { return `<div class="flex flex-col items-center justify-center h-full text-gray-400"><i class="fas fa-lock text-6xl mb-4"></i><p class="text-lg">คุณไม่มีสิทธิ์เข้าถึงหน้านี้</p></div>`; }

    window.onload = initApp;
  </script>
</body>
</html>
