/**
 * ระบบจัดการสต๊อกวัสดุ Test Kit – กลุ่มวิจัยเคมีดิน
 * Backend: Google Apps Script
 * Updated: Fix Permissions Save & Date
 */

// --- CONFIGURATION ---
const SPREADSHEET_ID = '13gspdOggRnXxC9-CHWP3ykIeN7nA9wGCt_iqKtPeDrg'; // ใส่ ID ของคุณ
const DRIVE_FOLDER_ID = '1on8dsnLVCZQZSqRxTSylFw4rA-rM6Kyf'; // ใส่ ID ของคุณ

// --- MAIN DO GET ---
function doGet(e) {
  try {
    return HtmlService.createHtmlOutputFromFile('index')
        .setTitle('ระบบจัดการสต๊อกวัสดุ Test Kit - กลุ่มวิจัยเคมีดิน')
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
        .addMetaTag('viewport', 'width=device-width, initial-scale=1');
  } catch (error) {
    return ContentService.createTextOutput("⚠️ ข้อผิดพลาด: ไม่พบไฟล์ HTML ชื่อ 'index'");
  }
}

// --- MAIN DO POST ---
function doPost(e) {
  try {
    const payload = JSON.parse(e.postData.contents);
    const result = apiHandler(payload);
    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.message })).setMimeType(ContentService.MimeType.JSON);
  }
}

// --- API ROUTER ---
function apiHandler(data) {
  const lock = LockService.getScriptLock();
  if (['register', 'addMaterial', 'updateMaterial', 'deleteMaterial', 'importMaterial', 'withdrawMaterial', 'uploadProof', 'updateUserStatus'].includes(data.action)) {
    lock.tryLock(10000); 
  }

  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let result = {};

    switch (data.action) {
      case 'login': result = loginUser(ss, data.payload); break;
      case 'register': result = registerUser(ss, data.payload); break;
      case 'getMaterials': result = getMaterials(ss); break;
      case 'addMaterial': result = addMaterial(ss, data.payload); break;
      case 'updateMaterial': result = updateMaterial(ss, data.payload); break;
      case 'deleteMaterial': result = deleteMaterial(ss, data.payload); break;
      case 'importMaterial': result = importMaterial(ss, data.payload); break;
      case 'withdrawMaterial': result = withdrawMaterial(ss, data.payload); break;
      case 'uploadProof': result = uploadTransactionProof(ss, data.payload); break;
      case 'getUsers': result = getUsers(ss); break;
      case 'updateUserStatus': result = updateUserStatus(ss, data.payload); break; // แก้ไขฟังก์ชันนี้
      case 'getReports': result = getReports(ss, data.payload); break;
      default: throw new Error('Action not found');
    }
    
    return { success: true, data: result };

  } catch (e) {
    return { success: false, error: e.message };
  } finally {
    lock.releaseLock();
  }
}

// --- HELPER: Upload Image ---
function saveImageToDrive(base64Data, fileName) {
  try {
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return "https://drive.google.com/thumbnail?id=" + file.getId() + "&sz=w1000"; 
  } catch (e) {
    throw new Error("Upload Failed: " + e.message);
  }
}

function generateUUID() { return Utilities.getUuid(); }

// --- AUTHENTICATION ---
function loginUser(ss, payload) {
  const sheet = ss.getSheetByName('Users');
  const users = getData(sheet);
  const passHash = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, payload.password).reduce((str,chr) => str + (chr < 0 ? chr + 256 : chr).toString(16).padStart(2,'0'),'');
  const user = users.find(u => u.username === payload.username && u.password === passHash);
  if (!user) throw new Error('ชื่อผู้ใช้งานหรือรหัสผ่านไม่ถูกต้อง');
  if (user.status !== 'approved') throw new Error('บัญชีของคุณยังไม่ได้รับการอนุมัติ');
  delete user.password;
  try { user.permissions = JSON.parse(user.permissions || '[]'); } catch(e) { user.permissions = []; }
  return user;
}

function registerUser(ss, payload) {
  const sheet = ss.getSheetByName('Users');
  const users = getData(sheet);
  if (users.find(u => u.username === payload.username)) throw new Error('Username นี้มีผู้ใช้งานแล้ว');
  const passHash = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, payload.password).reduce((str,chr) => str + (chr < 0 ? chr + 256 : chr).toString(16).padStart(2,'0'),'');
  const userId = 'U' + new Date().getTime();
  // Col H (index 7) is permissions
  sheet.appendRow([userId, payload.username, passHash, payload.fullname, payload.group, 'user', 'pending', JSON.stringify(['view_stock'])]);
  return { message: 'สมัครสมาชิกสำเร็จ รอการอนุมัติ' };
}

// --- USER MANAGEMENT ---
function getUsers(ss) {
  return getData(ss.getSheetByName('Users')).map(u => { delete u.password; return u; });
}

function updateUserStatus(ss, payload) {
  const sheet = ss.getSheetByName('Users');
  const data = sheet.getDataRange().getValues();
  // Columns: A=0(id), ..., F=5(role), G=6(status), H=7(permissions)
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == payload.user_id) {
      // 1. อัปเดตสถานะ (ถ้ามีส่งมา)
      if(payload.status) {
        sheet.getRange(i + 1, 7).setValue(payload.status);
      }
      
      // 2. อัปเดตสิทธิ์ (ถ้ามีส่งมา) - จุดที่เพิ่มใหม่
      if(payload.permissions) {
        // แปลง Array เป็น String ก่อนบันทึก
        const permString = typeof payload.permissions === 'object' ? JSON.stringify(payload.permissions) : payload.permissions;
        sheet.getRange(i + 1, 8).setValue(permString);
      }
      
      return { message: 'อัปเดตข้อมูลสำเร็จ' };
    }
  }
  throw new Error('ไม่พบ User ID');
}

// --- MATERIAL SYSTEM ---
function getMaterials(ss) {
  return getData(ss.getSheetByName('Materials'));
}

function addMaterial(ss, payload) {
  const sheet = ss.getSheetByName('Materials');
  const matId = 'M' + new Date().getTime();
  let imgUrl = payload.image_url;
  if (payload.image_data) imgUrl = saveImageToDrive(payload.image_data, payload.name + "_" + matId);
  sheet.appendRow([matId, imgUrl, payload.name, 0, '', '', '', '', '']);
  return { message: 'เพิ่มวัสดุสำเร็จ' };
}

function updateMaterial(ss, payload) {
  const sheet = ss.getSheetByName('Materials');
  const data = sheet.getDataRange().getValues();
  let newImgUrl = payload.image_url;
  if (payload.image_data) newImgUrl = saveImageToDrive(payload.image_data, payload.name + "_UPDATED");

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == payload.material_id) {
      sheet.getRange(i + 1, 2).setValue(newImgUrl);
      sheet.getRange(i + 1, 3).setValue(payload.name);
      return { message: 'แก้ไขวัสดุสำเร็จ' };
    }
  }
  throw new Error('ไม่พบรหัสวัสดุ');
}

function deleteMaterial(ss, payload) {
  const sheet = ss.getSheetByName('Materials');
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == payload.material_id) {
      sheet.deleteRow(i + 1);
      return { message: 'ลบวัสดุสำเร็จ' };
    }
  }
  throw new Error('ไม่พบรหัสวัสดุ');
}

// --- TRANSACTIONS ---
function importMaterial(ss, payload) {
  const matSheet = ss.getSheetByName('Materials');
  const logSheet = ss.getSheetByName('Import_History');
  const matData = matSheet.getDataRange().getValues();
  const timestamp = new Date();
  const txId = generateUUID();
  let proofUrl = '';

  if (payload.image_data) {
    proofUrl = saveImageToDrive(payload.image_data, "IMPORT_" + payload.material_name + "_" + timestamp.getTime());
  }

  let found = false;
  for (let i = 1; i < matData.length; i++) {
    if (matData[i][0] == payload.material_id) {
      const newQty = parseInt(matData[i][3] || 0) + parseInt(payload.qty);
      matSheet.getRange(i + 1, 4).setValue(newQty);
      matSheet.getRange(i + 1, 5).setValue(timestamp);
      matSheet.getRange(i + 1, 8).setValue(payload.user_name);
      matSheet.getRange(i + 1, 9).setValue(payload.ref_doc);
      found = true;
      break;
    }
  }
  if (!found) throw new Error('ไม่พบรหัสวัสดุ');
  logSheet.appendRow([timestamp, payload.material_id, payload.material_name, payload.qty, payload.user_name, payload.ref_doc, txId, proofUrl]);
  return { message: 'นำเข้าสต๊อกสำเร็จ' };
}

function withdrawMaterial(ss, payload) {
  const matSheet = ss.getSheetByName('Materials');
  const logSheet = ss.getSheetByName('Withdraw_History');
  const matData = matSheet.getDataRange().getValues();
  const timestamp = new Date();
  const txId = generateUUID();
  let proofUrl = '';

  if (payload.image_data) {
    proofUrl = saveImageToDrive(payload.image_data, "WITHDRAW_" + payload.material_name + "_" + timestamp.getTime());
  }

  let found = false;
  for (let i = 1; i < matData.length; i++) {
    if (matData[i][0] == payload.material_id) {
      const currentQty = parseInt(matData[i][3] || 0);
      const withdrawQty = parseInt(payload.qty);
      if (currentQty < withdrawQty) throw new Error('สต๊อกไม่พอ (เหลือ ' + currentQty + ')');
      
      matSheet.getRange(i + 1, 4).setValue(currentQty - withdrawQty);
      matSheet.getRange(i + 1, 6).setValue(timestamp);
      matSheet.getRange(i + 1, 7).setValue(payload.user_name);
      found = true;
      break;
    }
  }
  if (!found) throw new Error('ไม่พบรหัสวัสดุ');
  logSheet.appendRow([timestamp, payload.material_id, payload.material_name, payload.qty, payload.user_name, txId, proofUrl]);
  return { message: 'เบิกวัสดุสำเร็จ' };
}

function uploadTransactionProof(ss, payload) {
  const sheetName = payload.type === 'import' ? 'Import_History' : 'Withdraw_History';
  const sheet = ss.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  const txIdColIndex = payload.type === 'import' ? 6 : 5;
  const proofColIndex = payload.type === 'import' ? 7 : 6;
  const userColIndex = 4;

  for (let i = 1; i < data.length; i++) {
    if (data[i][txIdColIndex] == payload.transaction_id) {
      if (data[i][userColIndex] !== payload.user_name) throw new Error('คุณไม่มีสิทธิ์แก้ไขรายการของผู้อื่น');
      const proofUrl = saveImageToDrive(payload.image_data, "PROOF_" + payload.type + "_" + payload.transaction_id);
      sheet.getRange(i + 1, proofColIndex + 1).setValue(proofUrl);
      return { message: 'แนบรูปภาพสำเร็จ', url: proofUrl };
    }
  }
  throw new Error('ไม่พบรายการที่ระบุ');
}

function getReports(ss, payload) {
  const wSheet = ss.getSheetByName('Withdraw_History');
  const iSheet = ss.getSheetByName('Import_History');
  
  const mapData = (data, type) => {
    return data.map(r => ({
      ...r,
      transaction_id: type === 'withdraw' ? r['transaction_id'] || r[Object.keys(r)[5]] : r['transaction_id'] || r[Object.keys(r)[6]], 
      proof_url: type === 'withdraw' ? r['proof_url'] || r[Object.keys(r)[6]] : r['proof_url'] || r[Object.keys(r)[7]]
    }));
  };

  return {
    withdraw: mapData(getData(wSheet), 'withdraw').reverse().slice(0, 100),
    import: mapData(getData(iSheet), 'import').reverse().slice(0, 100)
  };
}

function getData(sheet) {
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1);
  return rows.map(row => {
    let obj = {};
    headers.forEach((h, i) => {
      if (row[i] instanceof Date) obj[h] = row[i].toISOString(); 
      else obj[h] = row[i];
    });
    return obj;
  });
}
